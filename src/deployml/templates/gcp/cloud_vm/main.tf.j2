provider "google" {
  project = "{{ project_id }}"
  region  = "{{ region }}"
  zone    = "{{ zone }}"
}

{% for stage in stack %}
  {% for stage_name, tool in stage.items() %}
    {% if stage_name == 'experiment_tracking' and tool.name in ['mlflow', 'wandb'] %}
module "{{ stage_name }}_{{ tool.name }}" {
  source     = "./modules/{{ tool.name }}/cloud/gcp/cloud_vm"
  project_id = var.project_id
  region     = var.region
  zone       = var.zone
  create_service = var.create_service
  create_bucket  = var.create_bucket
  service_name   = var.service_name
  vm_name        = var.vm_name
  machine_type   = var.machine_type
  disk_size_gb   = var.disk_size_gb
  disk_type      = var.disk_type
  image_family   = var.image_family
  artifact_bucket = var.artifact_bucket
  allow_public_access = var.allow_public_access
  network        = var.network
  subnetwork     = var.subnetwork
  allow_http_https = var.allow_http_https
  tags           = var.tags
  metadata       = var.metadata
  startup_script = var.startup_script
  {% if tool.name == 'mlflow' %}
  backend_store_uri = var.backend_store_uri
  image             = var.image
  mlflow_port       = var.mlflow_port
  use_postgres      = var.use_postgres
  cloudsql_instance_annotation = var.cloudsql_instance_annotation
  enable_https      = var.enable_https
  service_account_email = var.service_account_email
  {% elif tool.name == 'wandb' %}
  wandb_port        = var.wandb_port
  service_account_email = var.service_account_email
  {% endif %}
}
    {% endif %}
  {% endfor %}
{% endfor %}

# Outputs for experiment_tracking
{% for stage in stack %}
  {% for stage_name, tool in stage.items() %}
    {% if stage_name == 'experiment_tracking' and tool.name in ['mlflow', 'wandb'] %}
output "{{ stage_name }}_{{ tool.name }}_url" {
  value = module.{{ stage_name }}_{{ tool.name }}.service_url
}
output "{{ stage_name }}_{{ tool.name }}_bucket" {
  value = module.{{ stage_name }}_{{ tool.name }}.bucket_name
}
output "{{ stage_name }}_{{ tool.name }}_vm_name" {
  value = module.{{ stage_name }}_{{ tool.name }}.vm_name
}
output "{{ stage_name }}_{{ tool.name }}_zone" {
  value = module.{{ stage_name }}_{{ tool.name }}.zone
}
output "{{ stage_name }}_{{ tool.name }}_ssh_command" {
  value = module.{{ stage_name }}_{{ tool.name }}.ssh_command
}
output "{{ stage_name }}_{{ tool.name }}_external_ip" {
  value = module.{{ stage_name }}_{{ tool.name }}.vm_external_ip
}
    {% endif %}
  {% endfor %}
{% endfor %}
